{% extends "usuarios/home.html" %}
{% load static %}

{% block content %}

{% csrf_token %}

<div class="container-fluid">

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-shield-alt text-primary me-2"></i>Dashboard de Monitoreo
        </h1>
        <div>
            <button id="btn-sincronizar" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm me-2" onclick="sincronizarEventos()">
                <i class="fas fa-sync-alt fa-sm text-white-50 me-1"></i> Sincronizar
            </button>
            <button id="btn-ia" class="d-none d-sm-inline-block btn btn-sm btn-warning shadow-sm" onclick="ejecutarIA()">
                <i class="fas fa-robot fa-sm text-white-50 me-1"></i> Detectar IA
            </button>
        </div>
    </div>

    <div id="alert-container"></div>

    <div class="row">

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total de Eventos</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_eventos }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Anomal铆as Detectadas</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_anomalias }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Eventos Cr铆ticos</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ anomalias_criticas }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bolt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Eventos Normales</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ eventos_normales }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-filter me-1"></i> Filtros de B煤squeda</h6>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="small font-weight-bold">Buscador General</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0"><i class="fas fa-search text-gray-500"></i></span>
                        <input type="text" name="q" class="form-control bg-light border-0 small" 
                               placeholder="Usuario, IP, Archivo..." value="{{ busqueda_q }}">
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="small font-weight-bold">Tipo de Evento</label>
                    <select name="tipo" class="form-select form-control bg-light border-0 small">
                        <option value="">-- Todos --</option>
                        {% for t in tipos_evento %}
                        <option value="{{ t }}" {% if filtro_tipo == t %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="small font-weight-bold">Estado / Severidad</label>
                    <select name="anomalia" class="form-select form-control bg-light border-0 small">
                        <option value="">-- Todos --</option>
                        
                        <optgroup label="B谩sico">
                            <option value="no" {% if filtro_anomalia == 'no' %}selected{% endif %}> S贸lo Normales</option>
                            <option value="si" {% if filtro_anomalia == 'si' %}selected{% endif %}> Todas las Anomal铆as</option>
                        </optgroup>

                        <optgroup label="Por Severidad">
                            <option value="CRITICA" {% if filtro_anomalia == 'CRITICA' %}selected{% endif %}> S贸lo CRTICAS</option>
                            <option value="ALTA" {% if filtro_anomalia == 'ALTA' %}selected{% endif %}> S贸lo ALTAS</option>
                            <option value="MEDIA" {% if filtro_anomalia == 'MEDIA' %}selected{% endif %}>锔 S贸lo MEDIAS</option>
                        </optgroup>
                    </select>
                </div>

                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary btn-block w-100 shadow-sm">
                        Aplicar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Registro de Actividad Reciente</h6>
            <span class="badge bg-secondary">{{ page_obj.paginator.count }} registros</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                    <thead class="thead-light">
                        <tr>
                            <th>Fecha (UTC)</th>
                            <th>Usuario</th>
                            <th>Acci贸n</th>
                            <th>Archivo</th>
                            <th>IP</th>
                            <th class="text-center">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for evento in page_obj %}
                        <tr class="{% if evento.es_anomalia %}table-danger{% endif %}">
                            <td style="white-space: nowrap;">{{ evento.timestamp|date:"d/m/Y H:i" }}</td>
                            <td><small>{{ evento.email_usuario }}</small></td>
                            <td>
                                {% if 'edit' in evento.tipo_evento %}<span class="badge bg-warning text-dark"><i class="fas fa-pen"></i> Edit</span>
                                {% elif 'view' in evento.tipo_evento %}<span class="badge bg-info text-dark"><i class="fas fa-eye"></i> View</span>
                                {% elif 'download' in evento.tipo_evento %}<span class="badge bg-primary"><i class="fas fa-download"></i> Down</span>
                                {% else %}<span class="badge bg-secondary">{{ evento.tipo_evento }}</span>{% endif %}
                            </td>
                            <td><small>{{ evento.nombre_archivo|truncatechars:40 }}</small></td>
                            <td><small class="text-monospace">{{ evento.direccion_ip }}</small></td>
                            <td class="text-center">
                                {% if evento.es_anomalia %}
                                    <span class="badge {% if evento.severidad == 'CRITICA' %}bg-dark{% elif evento.severidad == 'ALTA' %}bg-danger{% else %}bg-warning text-dark{% endif %} shadow-sm"
                                          data-bs-toggle="tooltip" 
                                          data-bs-placement="top" 
                                          title="{{ evento.motivo_anomalia|default:'Anomal铆a detectada por IA' }}"
                                          style="cursor: help;">
                                        
                                        {% if evento.severidad == 'CRITICA' %} CRTICA
                                        {% elif evento.severidad == 'ALTA' %} ALTA
                                        {% else %}锔 MEDIA
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <span class="badge bg-success shadow-sm">Normal</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5 text-gray-500">
                                <i class="fas fa-folder-open fa-3x mb-3"></i><br>
                                No se encontraron eventos con los filtros actuales.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if page_obj.has_other_pages %}
            <div class="d-flex justify-content-center mt-4">
                <nav aria-label="Navegaci贸n de p谩ginas">
                    <ul class="pagination shadow-sm">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1&q={{ busqueda_q }}&tipo={{ filtro_tipo }}&anomalia={{ filtro_anomalia }}">Primera</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ busqueda_q }}&tipo={{ filtro_tipo }}&anomalia={{ filtro_anomalia }}">&laquo;</a>
                        </li>
                        {% endif %}

                        <li class="page-item disabled">
                            <span class="page-link bg-gray-200 text-gray-800">
                                P谩g {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                            </span>
                        </li>

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ busqueda_q }}&tipo={{ filtro_tipo }}&anomalia={{ filtro_anomalia }}">&raquo;</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ busqueda_q }}&tipo={{ filtro_tipo }}&anomalia={{ filtro_anomalia }}">ltima</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>

</div>

<style>
    .border-left-primary { border-left: 0.25rem solid #4e73df !important; }
    .border-left-success { border-left: 0.25rem solid #1cc88a !important; }
    .border-left-info { border-left: 0.25rem solid #36b9cc !important; }
    .border-left-warning { border-left: 0.25rem solid #f6c23e !important; }
    .border-left-danger { border-left: 0.25rem solid #e74a3b !important; }
    
    .text-gray-300 { color: #dddfeb !important; }
    .text-gray-800 { color: #5a5c69 !important; }
    
    .badge { padding: 0.5em 0.75em; }
    .text-monospace { font-family: monospace; }
    
    /* Estilo para que el tooltip se vea mejor si usas Bootstrap est谩ndar */
    .tooltip-inner {
        max-width: 300px;
        text-align: left;
    }
</style>

<script>
    // --- 1. Inicializaci贸n de Tooltips (NUEVO SPRINT 6) ---
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function mostrarAlerta(mensaje, tipo) {
        const container = document.getElementById('alert-container');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show shadow-sm`;
        alertDiv.innerHTML = `
            <strong>${tipo === 'success' ? '隆xito!' : 'Atenci贸n:'}</strong> ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        container.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    function sincronizarEventos() {
        const btn = document.getElementById('btn-sincronizar');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Procesando...';

        fetch("{% url 'monitoreo:api_sincronizar' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta(data.mensaje, 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                mostrarAlerta('Error: ' + (data.message || data.error), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarAlerta('Error de conexi贸n con el servidor', 'danger');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sync-alt fa-sm text-white-50 me-1"></i> Sincronizar';
        });
    }

    function ejecutarIA() {
        const btn = document.getElementById('btn-ia');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-cog fa-spin me-1"></i> Analizando...';

        fetch("{% url 'monitoreo:api_detectar' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')}
        })
        .then(response => response.json())
        .then(data => {
            mostrarAlerta(data.mensaje, 'info');
            setTimeout(() => location.reload(), 2000);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-robot fa-sm text-white-50 me-1"></i> Detectar IA';
        });
    }
</script>

{% endblock %}